
name: Keep Render Service Alive

on:
  schedule:
    - cron: '*/1 * * * *'  # Every 14 minutes
  workflow_dispatch:

jobs:
  ping-and-log:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ping API and Store Log
      run: |
        echo "ðŸ•’ Starting API check at $(date)"
        
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        START_TIME=$(date +%s)
        
        # Ping the main API
        RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://api.xecrontechnologies.in/api")
        END_TIME=$(date +%s)
        RESPONSE_TIME=$((END_TIME - START_TIME))
        
        # Prepare log data
        if [ "$RESPONSE_CODE" -eq 200 ]; then
          STATUS="success"
          MESSAGE="API is responding correctly"
        else
          STATUS="failed"
          MESSAGE="API returned status: $RESPONSE_CODE"
        fi
        
        # Create log entry
        LOG_DATA=$(cat << EOF
        {
          "path": ["render_cron_log"],
          "ser_acc_id": "766658435727",
          "data": {
            "timestamp": "$TIMESTAMP",
            "status": "$STATUS",
            "response_code": $RESPONSE_CODE,
            "response_time_seconds": $RESPONSE_TIME,
            "message": "$MESSAGE",
            "source": "github_actions"
          }
        }
        EOF
        )
        
        echo "Log data: $LOG_DATA"
        
        # Send to Firebase
        FIREBASE_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d "$LOG_DATA" \
          "https://api.xecrontechnologies.in/api/firebase/create")
        
        # Extract HTTP status
        HTTP_STATUS=$(echo "$FIREBASE_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        RESPONSE_BODY=$(echo "$FIREBASE_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*//g')
        
        echo "Firebase API Response: $RESPONSE_BODY"
        echo "Firebase API Status: $HTTP_STATUS"
        
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "âœ… Log stored successfully in Firebase"
        else
          echo "âŒ Failed to store log in Firebase"
          exit 1
        fi
#///////////Old - v1 /////////////////////
# name: Keep Render Service Alive

# on:
#   schedule:
#     - cron: '*/14 * * * *'
#   workflow_dispatch:

# jobs:
#   ping:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Ping Render Service
#         run: curl -s https://api.xecrontechnologies.in/api
